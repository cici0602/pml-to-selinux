# Phase 2 示例：完整的 Web 应用策略
# 展示：目录递归、角色映射、域转换、动作映射

# === 角色关系 (Role Hierarchy) ===
# 定义用户-角色关系
g, webapp_user, webapp_staff
g, webapp_staff, webapp_admin
g, webapp_admin, sysadm

# === Web 应用主域策略 ===
# Web 应用可以读写自己的内容目录（递归）
p, webapp_t, /var/www/webapp/*, read, file, allow
p, webapp_t, /var/www/webapp/*, write, file, allow
p, webapp_t, /var/www/webapp/*, execute, file, allow

# Web 应用可以写日志（递归目录支持）
p, webapp_t, /var/log/webapp/*, write, file, allow
p, webapp_t, /var/log/webapp/*, append, file, allow
p, webapp_t, /var/log/webapp/*, create, file, allow

# Web 应用可以读配置文件（递归）
p, webapp_t, /etc/webapp/*, read, file, allow
p, webapp_t, /etc/webapp/*, getattr, file, allow

# Web 应用可以访问临时文件目录（递归）
p, webapp_t, /var/tmp/webapp/*, read, file, allow
p, webapp_t, /var/tmp/webapp/*, write, file, allow
p, webapp_t, /var/tmp/webapp/*, create, file, allow
p, webapp_t, /var/tmp/webapp/*, delete, file, allow

# === 网络权限 ===
p, webapp_t, tcp_socket, bind, tcp_socket, allow
p, webapp_t, tcp_socket, listen, tcp_socket, allow
p, webapp_t, tcp_socket, accept, tcp_socket, allow

# === 子进程域转换 ===
# Web 应用可以启动后台处理器，转换到 worker 域
t, webapp_t, webapp_worker_exec_t, process, webapp_worker_t

# Worker 进程的权限
p, webapp_worker_t, /var/www/webapp/data/*, read, file, allow
p, webapp_worker_t, /var/www/webapp/data/*, write, file, allow
p, webapp_worker_t, /var/log/webapp/*, write, file, allow

# === 数据库访问域转换 ===
# Web 应用连接数据库时转换到 dbclient 域
t, webapp_t, webapp_dbclient_exec_t, process, webapp_dbclient_t

# 数据库客户端权限
p, webapp_dbclient_t, /var/lib/webapp/db/*, read, file, allow
p, webapp_dbclient_t, /var/lib/webapp/db/*, write, file, allow
p, webapp_dbclient_t, tcp_socket, connect, tcp_socket, allow

# === 管理域 ===
# 管理员可以完全控制 webapp
p, webapp_admin_t, /var/www/webapp/*, rwx, file, allow
p, webapp_admin_t, /etc/webapp/*, rw, file, allow
p, webapp_admin_t, /var/log/webapp/*, read, file, allow

# 管理员可以控制 webapp 进程
p, webapp_admin_t, webapp_t, signal, process, allow
p, webapp_admin_t, webapp_t, sigkill, process, allow

# === 禁止规则 ===
# 禁止 webapp 写入系统二进制目录
p, webapp_t, /usr/bin/*, write, file, deny
p, webapp_t, /usr/sbin/*, write, file, deny
p, webapp_t, /bin/*, write, file, deny
p, webapp_t, /sbin/*, write, file, deny

# 禁止 webapp 访问其他应用的数据
p, webapp_t, /var/lib/mysql/*, read, file, deny
p, webapp_t, /var/lib/postgresql/*, read, file, deny

# === 目录操作 ===
# 允许 webapp 在自己的目录中创建和删除文件
p, webapp_t, /var/www/webapp/uploads/*, add_name, dir, allow
p, webapp_t, /var/www/webapp/uploads/*, remove_name, dir, allow
p, webapp_t, /var/www/webapp/uploads/*, search, dir, allow

# === 执行权限 ===
# 允许 webapp 执行辅助脚本
p, webapp_t, /usr/local/bin/webapp-helper, execute, file, allow
p, webapp_t, /usr/local/bin/webapp-cron, execute, file, allow
