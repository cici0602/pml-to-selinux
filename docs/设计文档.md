# Casbin PML to SELinux 编译器设计文档

## 项目概述

**目标**: 将 Casbin 的 PML (Policy Modeling Language) 作为更高层次、更抽象的策略描述语言，能够编译生成 SELinux 策略。通过这种方式，用户可以使用更易理解的 Casbin PML 编写安全策略，而不需要直接编写和维护复杂的 SELinux 策略。

**核心理念**: 
- Casbin PML 是更高层的抽象层
- SELinux 策略是编译目标
- 在 Casbin PML 层面进行策略分析、验证和管理
- 理想情况下，用户无需接触 SELinux 策略语法

## 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    Casbin PML Layer                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  PML Model   │  │ PML Policies │  │  Analysis    │     │
│  │  (.conf)     │  │  (.csv)      │  │  Tools       │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
                  ┌─────────────────┐
                  │   PML Compiler  │
                  │   (Translator)  │
                  └─────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   SELinux Policy Layer                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  .te files   │  │ .fc files    │  │  .if files   │     │
│  │  (type       │  │ (file        │  │  (interface  │     │
│  │   enforce)   │  │  context)    │  │   defs)      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

## 概念映射表

| SELinux 概念                                |                         对应 Casbin/PML 概念 | 说明                                                           |
| ----------------------------------------- | ---------------------------------------: | ------------------------------------------------------------ |
| `type` / `domain` (e.g. `httpd_t`)        |                        `subject`（或 role） | 把 type 当作主体标识或角色。                                            |
| `file context` (path → type)              |                    `object`（可以用 path 模式） | 需要把 file context 转为对象模式（如 `/var/log/*`）。                     |
| `class` + `permission` (e.g. `file read`) |                   `action` (e.g. `read`) | SELinux 的 class（file, dir, tcp_socket）需映射为对象的类型/子类或策略中的额外字段。 |
| `allow source_t target_t:class perms;`    | `p, source_t, target_path_pattern, perm` | 将 target_t 用路径模式或逻辑标签替代（需要额外元信息）。                            |
| `role`、`user`（SELinux RBAC）               |            Casbin 的 role/g（group/role继承） | 可直接映射为 Casbin 的角色关系。                                         |
| `type_transition`（domain transition）      |     **难以直接表达**（需要额外 state/transition 机制） | PML 本身不是状态机，需借助外部逻辑或扩展。                                      |
| `boolean`（policy boolean）                 |           Casbin: 可用策略变量或 matcher 中的全局变量 | 能映射，但需要在运行时注入到 matcher/enforcer 中。                           |

## PML 模型设计

### 1. SELinux 风格的 PML 模型示例

```ini
[request_definition]
r = sub, obj, act, class

[policy_definition]
p = sub, obj, act, class, eft

[role_definition]
g = _, _
g2 = _, _  # for type attributes

[policy_effect]
e = some(where (p.eft == allow)) && !some(where (p.eft == deny))

[matchers]
m = g(r.sub, p.sub) && matchPath(r.obj, p.obj) && r.act == p.act && r.class == p.class
```

### 2. 策略文件格式

```csv
# Type enforcement rules
p, httpd_t, /var/www/*, read, file, allow
p, httpd_t, /var/www/*, write, file, allow
p, httpd_t, /var/log/httpd/*, write, file, allow
p, httpd_t, /etc/*, read, file, allow
p, httpd_t, /etc/*, write, file, deny

# Type attributes (group membership)
g2, httpd_t, web_domain
g2, nginx_t, web_domain

# Role assignments
g, user_u, user_r
g, system_u, system_r
```

## 编译器组件设计

### 1. 核心模块

```
pml-to-selinux/
├── compiler/
│   ├── parser.go          # PML 解析器
│   ├── analyzer.go        # 语义分析器
│   ├── generator.go       # SELinux 代码生成器
│   └── optimizer.go       # 策略优化器
├── mapping/
│   ├── type_mapping.go    # 类型映射
│   ├── context_mapping.go # 上下文映射
│   └── permission_mapping.go # 权限映射
├── selinux/
│   ├── te_generator.go    # .te 文件生成
│   ├── fc_generator.go    # .fc 文件生成
│   └── if_generator.go    # .if 文件生成
├── validator/
│   ├── pml_validator.go   # PML 验证
│   └── selinux_validator.go # SELinux 策略验证
└── cli/
    └── main.go            # 命令行工具
```

### 2. 编译流程

```
PML Model + Policies
        ↓
   [Parser] ← 解析 PML 配置和策略
        ↓
   [Analyzer] ← 语义分析、类型检查、冲突检测
        ↓
   [Mapper] ← 概念映射、上下文构建
        ↓
   [Optimizer] ← 策略优化、合并、去重
        ↓
   [Generator] ← 生成 SELinux 策略文件
        ↓
   [Validator] ← 验证生成的策略
        ↓
SELinux Policy Package (.te, .fc, .if)
```

## 关键技术挑战

### 1. 路径模式转换
- **挑战**: 将 Casbin 的路径匹配模式转换为 SELinux file context
- **解决方案**: 
  - 使用正则表达式映射
  - 维护路径模式到 SELinux type 的映射表
  - 生成对应的 .fc 文件

### 2. 动态上下文转换
- **挑战**: SELinux 的 type_transition 在 PML 中难以表达
- **解决方案**:
  - 扩展 PML 语法支持状态转换
  - 或通过预定义的转换规则集
  - 生成标准的 type_transition 规则

### 3. 对象类别管理
- **挑战**: SELinux 有多种 object class (file, dir, socket, etc.)
- **解决方案**:
  - 在 PML 中添加 class 字段
  - 提供默认类别映射
  - 允许用户自定义类别

### 4. 策略冲突解决
- **挑战**: allow 和 deny 规则的优先级处理
- **解决方案**:
  - 在 PML 层面进行冲突检测
  - 提供明确的优先级规则
  - 生成清晰的 SELinux 策略

